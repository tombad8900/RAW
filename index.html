<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>WAR-CORE V20 [Ultima]</title>

<style>
html,body{
margin:0;
height:100%;
background:#000;
overflow:hidden;
font-family:system-ui;
}
canvas{display:block}
</style>
</head>
<body>

<canvas id="c"></canvas>

<script>
"use strict";

/* ==============================
   CONSTANTS
============================== */

const DPR_MAX = 2;
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d",{alpha:false,desynchronized:true}) 
          || canvas.getContext("2d");

let w=0,h=0,dpr=1;

/* ==============================
   BACK BUFFER (MAJOR GPU FIX)
============================== */

let back = document.createElement("canvas");
let bctx = back.getContext("2d");

/* ==============================
   OFFSCREEN
============================== */

let grid,scan,noise;
let matrixDrops=[];

/* ==============================
   RESIZE
============================== */

function resize(){

dpr=Math.min(devicePixelRatio||1,DPR_MAX);

w=innerWidth;
h=innerHeight;

canvas.width=w*dpr;
canvas.height=h*dpr;

canvas.style.width=w+"px";
canvas.style.height=h+"px";

back.width=w;
back.height=h;

ctx.setTransform(dpr,0,0,dpr,0,0);

buildGrid();
buildScan();
buildNoise();
initMatrix();
}

addEventListener("resize",debounce(resize,120));

/* ==============================
   GRID CACHE
============================== */

function buildGrid(){

grid=document.createElement("canvas");
grid.width=w;
grid.height=h;

const g=grid.getContext("2d");

const spacing=Math.max(20,Math.min(w,h)*0.04);

g.strokeStyle="rgba(0,255,120,.05)";

for(let x=0;x<w;x+=spacing){
g.beginPath();
g.moveTo(x,0);
g.lineTo(x,h);
g.stroke();
}

for(let y=0;y<h;y+=spacing){
g.beginPath();
g.moveTo(0,y);
g.lineTo(w,y);
g.stroke();
}
}

/* ==============================
   SCANLINES CACHE
============================== */

function buildScan(){

scan=document.createElement("canvas");
scan.width=w;
scan.height=h;

const s=scan.getContext("2d");

s.fillStyle="rgba(0,0,0,.08)";

for(let y=0;y<h;y+=4){
s.fillRect(0,y,w,1);
}
}

/* ==============================
   NOISE CACHE
============================== */

function buildNoise(){

noise=document.createElement("canvas");
noise.width=220;
noise.height=220;

const n=noise.getContext("2d");
const img=n.createImageData(220,220);

for(let i=0;i<img.data.length;i+=4){
const v=Math.random()*255;
img.data[i]=v;
img.data[i+1]=v;
img.data[i+2]=v;
img.data[i+3]=12;
}

n.putImageData(img,0,0);
}

/* ==============================
   MATRIX
============================== */

function initMatrix(){

matrixDrops=[];

const font=16;

for(let i=0;i<w/font;i++){
matrixDrops[i]=Math.random()*-h;
}
}

function drawMatrix(ctx,glitch){

const font=16+glitch;
ctx.font=`${font}px monospace`;
ctx.fillStyle=`rgba(0,${180+glitch*4},0,.75)`;

for(let i=0;i<matrixDrops.length;i++){

const x=i*font;
const y=matrixDrops[i];

ctx.fillText(Math.random()>.5?"0":"1",x,y);

if(y>h && Math.random()>.975)
matrixDrops[i]=0;

matrixDrops[i]+=1.1+glitch*.25;
}
}

/* ==============================
   FX
============================== */

function horizontalTear(ctx,glitch){

if(glitch<6 || Math.random()>.05) return;

const slice=8+Math.random()*14;
const y=Math.random()*h;
const offset=(Math.random()-.5)*60;

ctx.drawImage(
back,
0,y,w,slice,
offset,y,w,slice
);
}

/* ==============================
   TEXT (keeps your visual style)
============================== */

let cachedFont="";
let cachedSize=0;

function drawText(ctx,lines,glitch){

if(!lines.length) return;

let fs=Math.min(w*.12,(h*.8)/(lines.length*1.2));

if(fs!==cachedSize){
cachedSize=fs;
cachedFont=`900 ${Math.floor(fs)}px system-ui`;
}

ctx.font=cachedFont;

let widest=0;

for(const l of lines){
widest=Math.max(widest,ctx.measureText(l).width);
}

if(widest>w*.9){
fs*=w*.9/widest;
ctx.font=`900 ${Math.floor(fs)}px system-ui`;
}

const lh=fs*1.2;
const startY=h/2-(lines.length*lh)/2+lh/2;

ctx.textAlign="center";
ctx.textBaseline="middle";

lines.forEach((line,i)=>{

const y=startY+i*lh;
const x=w/2;
const shift=Math.max(1,fs*.015);

// aberration
ctx.fillStyle="rgba(255,0,0,.75)";
ctx.fillText(line,x-shift,y);

ctx.fillStyle="rgba(0,255,255,.75)";
ctx.fillText(line,x+shift,y);

// main
ctx.lineWidth=fs*.06;
ctx.strokeStyle="#000";
ctx.fillStyle="#fff";

ctx.strokeText(line,x,y);
ctx.fillText(line,x,y);

});
}

/* ==============================
   LOOP
============================== */

let last=performance.now();
let glitch=0;
let lines=["WAR-CORE ACTIVE"];

function render(t){

const dt=t-last;
last=t;

glitch=Math.max(0,glitch*.9-.02);

// draw on back buffer
bctx.fillStyle="#000";
bctx.fillRect(0,0,w,h);

bctx.drawImage(grid,0,0);

drawMatrix(bctx,glitch);
drawText(bctx,lines,glitch);

bctx.drawImage(scan,0,0);

bctx.globalAlpha=.22;
bctx.drawImage(noise,0,0,w,h);
bctx.globalAlpha=1;

horizontalTear(bctx,glitch);

// present once (kills tearing)
ctx.drawImage(back,0,0);

raf=requestAnimationFrame(render);
}

/* ==============================
   VISIBILITY GPU SAVE
============================== */

let raf;

document.addEventListener("visibilitychange",()=>{

if(document.hidden){
cancelAnimationFrame(raf);
}else{
last=performance.now();
raf=requestAnimationFrame(render);
}
});

/* ==============================
   HELPERS
============================== */

function debounce(fn,ms){
let t;
return(...a)=>{
clearTimeout(t);
t=setTimeout(()=>fn(...a),ms);
};
}

/* ==============================
   START
============================== */

resize();
raf=requestAnimationFrame(render);
</script>
</body>
</html>
